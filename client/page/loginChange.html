<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>carryAll_회원정보 수정폼</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/login.css" />
    <link rel="stylesheet" href="../css/join.css" />
  </head>
  <body>
    <!-- 헤더 가져오기 -->
    <header id="header"></header>

    <!-- 컨텐츠 -->
    <section class="container joinFormWarp">
      <form
        id="signupForm"
        action="javascript:void(0);"
        method="post"
        class="inputForm"
      >
        <fieldset>
          <legend class="formTit">회원정보 수정</legend>
          <div class="box formBox">
            <ul class="joinBox">
              <!-- 1. 아이디 -->
              <li>
                <label for="idName" class="label">
                  <span>아이디</span>
                  <input
                    style="background-color: #fff"
                    type="text"
                    class="inputType01"
                    id="idName"
                    required=""
                    value="get예정(수정불가)"
                    disabled
                  />
                </label>
              </li>
              <!-- 2. 비밀번호 변경 -->
              <li>
                <label for="password" class="label">
                  <span>비밀번호 변경</span>
                  <input
                    type="password"
                    class="inputType01"
                    id="password"
                    required=""
                  />
                </label>
              </li>

              <!-- 3. 비밀번호 확인 -->
              <li>
                <label for="passwordReconfirm" class="label">
                  <span>비밀번호 확인</span>
                  <input
                    type="password"
                    class="inputType01"
                    id="passwordReconfirm"
                    required=""
                  />
                </label>
                <div class="errTxt n1">입력된 비밀번호를 확인하세요.</div>
              </li>

              <!-- 4. 이름 -->
              <li>
                <label for="name" class="label">
                  <span>이름</span>
                  <input
                    style="background-color: #fff"
                    type="text"
                    class="inputType01"
                    id="name"
                    required=""
                    value="엘리스(수정불가)"
                    disabled
                  />
                </label>
              </li>

              <!-- 5. 이메일 -->
              <li class="f_fs f_d_c label02">
                <label for="email" class="label">
                  <span>이메일</span>
                  <input type="text" class="inputType01" id="email" />
                </label>
                <div class="errTxt n2">이메일 주소를 확인하세요.</div>
              </li>
              <!-- 6. 휴대폰 번호 -->
              <li>
                <label for="phoneNum" class="label">
                  <span>휴대폰 번호</span>
                  <input
                    type="text"
                    class="inputType01"
                    id="phoneNum"
                    required=""
                    maxlength="13"
                  />
                </label>
              </li>
            </ul>

            <!-- 7. 주소 -->
            <li>
              <label
                style="justify-content: flex-start"
                for="address01"
                class="label"
              >
                <span>주소</span>
                <input
                  style="margin-left: 15.1%; margin-right: 20px"
                  type="text"
                  name="address"
                  id="address01"
                  class="inputType01"
                  style="width: 54%; margin-left: 13.4%; margin-right: 20px"
                />
                <a
                  class="addressBtn"
                  href="javascript:void(0);"
                  onclick="findAddr()"
                  >우편번호 검색</a
                >
              </label>
              <div
                style="flex-direction: column; align-items: flex-end"
                class="address_line address_line02 f_c label"
              >
                <label for="address02" class="label"></label>
                <input
                  style="margin-top: 20px"
                  type="text"
                  name="address"
                  id="address02"
                  class="inputType01"
                />
                <label for="address03" class="label"></label>
                <input
                  style="margin-top: 20px"
                  type="text"
                  name="address"
                  id="address03"
                  class="inputType01"
                  placeholder="추가 상세 주소를 입력하세요."
                />
              </div>
            </li>
            <div class="joinBtn btn_box">
              <button
                style="width: 100%"
                type="submit"
                class="btnType02 modifyForm"
                onclick="updateUserInfo()"
              >
                회원정보 변경하기
              </button>
            </div>
          </div>
        </fieldset>
      </form>
    </section>

    <!-- 푸터 가져오기 -->
    <footer id="footer"></footer>

    <!-- 탑버튼 가져오기 -->
    <div class="top">top</div>

    <script src="../js/top.js"></script>
    <script src="../js/header.js"></script>
    <script src="../js/footer.js"></script>
    <!-- 회원가입 폼 script -->
    <script src="../js/join.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>

    <!-- 우편번호 API -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
    <script>
      // 우편번호 api
      function findAddr() {
        new daum.Postcode({
          oncomplete: function (data) {
            console.log(data);
            var postInput = document.getElementById("address01");
            var addrInput = document.getElementById("address02");
            postInput.value = data.zonecode; // 우편번호 입력란에 우편번호 설정
            addrInput.value = data.roadAddress || data.jibunAddress; // 도로명 주소가 있으면 roadAddress, 없으면 jibunAddress 설정
          },
        }).open();
      }

      // 1. 서버로부터 사용자 정보를 가져와서 각 input 요소에 채워넣는 함수
      function fetchUserData() {
        const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

        axios
          .get("/api/userEdit")
          .then((response) => {
            const userData = response.data;
            // 사용자 정보를 각 input 요소에 채워넣습니다.
            document.getElementById("idName").value = userData.username;
            document.getElementById("name").value = userData.name;
            document.getElementById("email").value = userData.email;
            document.getElementById("phoneNum").value = userData.tel;
            document.getElementById("address01").value = userData.zipCode;
            document.getElementById("address02").value = userData.address;
            document.getElementById("address03").value = userData.addressDetail;
          })
          .catch((error) => {
            console.error("데이터를 가져오는 데 실패했습니다:", error);
          });
      }
      // 페이지 로드 시 사용자 정보를 가져와서 각 input 요소에 채워넣습니다.
      fetchUserData();

      const signupForm = document.getElementById("signupForm");

      // 2. submit 이벤트 리스너 밖으로 updateUserInfo 함수를 이동합니다.
      function updateUserInfo() {
        const username = document.getElementById("idName").value;
        const password = document.getElementById("password").value; // 변경된 비밀번호
        const passwordReconfirm =
          document.getElementById("passwordReconfirm").value; // 변경된 비밀번호
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const phoneNum = document.getElementById("phoneNum").value;
        const address01 = document.getElementById("address01").value;
        const address02 = document.getElementById("address02").value;
        const address03 = document.getElementById("address03").value;

        axios
          .put("/api/user", {
            username: username,
            password: password,
            passwordReconfirm: passwordReconfirm,
            email: email,
            tel: phoneNum,
            name: name,
            zipCode: address01,
            address: address02,
            addressDetail: address03,
          })
          .then((response) => {
            // 서버로부터의 응답을 처리, 완료 페이지로 이동
            console.log("회원가입이 완료되었습니다.", response.data);
            window.location.href = "/mypage";
          })
          .catch((error) => {
            console.error("회원가입 오류:", error.response.data);

            if (typeof error.response.data == "object") {
              alert(error.response.data.message);
            } else {
              alert(error.response.data[0]);
            }
          });
      }

      // 2. 비밀번호 일치 여부를 확인하는 함수
      function checkPassword() {
        const password = document.getElementById("password").value;
        const errorText0 = document.querySelector(".errTxt.n0"); // 비밀번호 길이 에러 메시지

        // 비밀번호 길이가 10자리 미만인 경우
        if (password.length < 10) {
          errorText0.classList.add("active");
        } else {
          errorText0.classList.remove("active");
        }
      }
      document
        .getElementById("password")
        .addEventListener("input", checkPassword);

      // 3. 전화번호 관련 유효성 추가
      function formatPhoneNumber() {
        const phoneNumberInput = document.getElementById("phoneNum");
        let phoneNumber = phoneNumberInput.value.replace(/[^\d]/g, ""); // 숫자 이외의 문자 모두 제거

        // 포맷 적용
        if (phoneNumber.length >= 4 && phoneNumber.length <= 7) {
          phoneNumber = phoneNumber.replace(/(\d{3})(\d{1,4})/, "$1-$2");
        } else if (phoneNumber.length >= 8) {
          phoneNumber = phoneNumber.replace(
            /(\d{3})(\d{4})(\d{1,4})/,
            "$1-$2-$3"
          );
        }
        phoneNumberInput.value = phoneNumber;
      }

      // 휴대폰 번호 입력란에 input 이벤트 추가하여 입력할 때마다 포맷 변경
      document
        .getElementById("phoneNum")
        .addEventListener("input", formatPhoneNumber);
    </script>
  </body>
</html>
